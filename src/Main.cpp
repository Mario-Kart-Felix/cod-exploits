#include "STDInclude.hpp"

#include "Extern/Huffman.hpp"

#include "Network/Address.hpp"
#include "Network/Sniffer.hpp"

#include "Game/MW2/Handler.hpp"

int main(int /*argc*/, char** /*argv*/)
{
	SetConsoleTitleA("COD exploiter");
	Utils::SetEnvironment();

	Network::Sniffer sniffer;
	Game::MW2::Handler handler(&sniffer);

	Utils::SignalHandler sigHandler([&sniffer]()
	{
		sniffer.stop();
	});

	std::thread commandThread([&handler, &sniffer]()
	{
		std::string cmdStr;
		
		while (sniffer.isRunning())
		{
			int command = _getch();
			cmdStr.clear();
			cmdStr.reserve(2);
			cmdStr.push_back(char(command));
			cmdStr.push_back(0);
			int num = atoi(cmdStr.data());

			if (sniffer.isRunning())
			{
				printf("Sending payload %d...\n", num);
				handler.sendPayload(&sniffer, num);
			}
		}

	});

	sniffer.run();

	if (commandThread.joinable()) commandThread.join();
	return 0;
}
