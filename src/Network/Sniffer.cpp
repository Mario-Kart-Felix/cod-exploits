#include "STDInclude.hpp"

#include "Network/Address.hpp"
#include "Network/Sniffer.hpp"

namespace Network
{
	void Sniffer::stop()
	{
		this->stopped = true;
	}

	void Sniffer::run()
	{
		Utils::Memory::Allocator allocator;

		u_int size = 0;
		const u_int maxSize = 0x10000;
		u_char* buffer = allocator.allocateArray<u_char>(maxSize);

		auto winDiverSend    = this->divert.get<BOOL(__stdcall)(HANDLE, PVOID, UINT, PWINDIVERT_ADDRESS, UINT*)>("WinDivertSend");
		auto winDiverReceive = this->divert.get<BOOL(__stdcall)(HANDLE, PVOID, UINT, PWINDIVERT_ADDRESS, UINT*)>("WinDivertRecv");

		Packet packet;
		while (!this->stopped && this->handle != INVALID_HANDLE_VALUE)
		{
			if (winDiverReceive(this->handle, buffer, maxSize, &packet.address, &size) == TRUE)
			{
				PWINDIVERT_IPHDR ipHeader = PWINDIVERT_IPHDR(buffer);
				PWINDIVERT_UDPHDR udpHeader = PWINDIVERT_UDPHDR(buffer + (ipHeader->HdrLength * 4));

				packet.drop = false;
				packet.sniffer = this;
				packet.rawData = std::string_view(LPSTR(buffer), size);
				packet.data = std::string_view(LPSTR(udpHeader) + sizeof(WINDIVERT_UDPHDR), udpHeader->Length - sizeof(WINDIVERT_UDPHDR));

				IN_ADDR addr;
				addr.S_un.S_addr = ipHeader->SrcAddr;
				packet.source.setIPv4(addr);

				addr.S_un.S_addr = ipHeader->DstAddr;
				packet.target.setIPv4(addr);

				packet.source.setPort(ntohs(udpHeader->SrcPort));
				packet.target.setPort(ntohs(udpHeader->DstPort));

				if (this->callback) this->callback(&packet);
				if (!packet.drop) winDiverSend(this->handle, PVOID(packet.rawData.data()), UINT(packet.rawData.size()), &packet.address, &size);
			}
			else
			{
				std::this_thread::yield();
			}
		}
	}

	bool Sniffer::send(Network::Packet* packet)
	{
		this->divert.invokePascal<BOOL>("WinDivertHelperCalcChecksums", PVOID(packet->rawData.data()), UINT(packet->rawData.size()), 0ui64);

		u_int size = 0;
		BOOL result = this->divert.invokePascal<BOOL>("WinDivertSend", this->handle, PVOID(packet->rawData.data()), UINT(packet->rawData.size()), &packet->address, &size) == TRUE;
		return (result && size == packet->rawData.size());
	}

	void Sniffer::onPacket(Callback _callback)
	{
		this->callback = _callback;
	}

	Sniffer::Sniffer() : stopped(false)
	{
		this->divert = Utils::NT::Module::Load("WinDivert.dll");
		if (this->divert.isValid())
		{
				this->handle = this->divert.invokePascal<HANDLE>("WinDivertOpen", "ip and udp", WINDIVERT_LAYER_NETWORK, -1000i16, 0ui64);
		}
	}

	Sniffer::~Sniffer()
	{
		if (this->handle != INVALID_HANDLE_VALUE)
		{
			this->divert.invokePascal<BOOL>("WinDivertClose", this->handle);
			this->handle = INVALID_HANDLE_VALUE;
		}
	}
}
